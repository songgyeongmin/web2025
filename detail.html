const API_KEY = "d0nkc2pr01qn5ghk9h20d0nkc2pr01qn5ghk9h2g";

const urlParams = new URLSearchParams(window.location.search);
let symbol = urlParams.get('symbol');

if(symbol && symbol.includes(':')) {
  symbol = symbol.split(':')[0];
}

if (!symbol) {
  alert("종목이 없습니다.");
} else {
  document.getElementById("stockTitle").textContent = `${symbol} 상세 정보`;

  fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("currentPrice").textContent = `$${data.c}`;
      document.getElementById("highPrice").textContent = `$${data.h}`;
      document.getElementById("lowPrice").textContent = `$${data.l}`;
      document.getElementById("prevClose").textContent = `$${data.pc}`;
    })
    .catch(err => console.error("가격 불러오기 오류", err));

  const now = Math.floor(Date.now() / 1000);
  const oneMonthAgo = now - 60 * 60 * 24 * 30;

  fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${oneMonthAgo}&to=${now}&token=${API_KEY}`)
    .then(res => res.json())
    .then(data => {
      if (data.s !== "ok") {
        throw new Error("차트 데이터 오류");
      }

      const labels = data.t.map(t => {
        const date = new Date(t * 1000);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      });

      const ctx = document.getElementById("stockChart").getContext("2d");
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `${symbol} 종가`,
            data: data.c,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: '날짜' }
            },
            y: {
              title: { display: true, text: '가격 ($)' }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error("차트 오류", err);
      document.getElementById("chartContainer").innerHTML = "<p style='color:red;'>차트 불러오기에 실패했습니다.</p>";
    });
}
